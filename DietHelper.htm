<html>
<head>
<title>Diet Helper</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script>

// --------------------
const globalDebug = 0;
// --------------------

const ingredients = [ 
		// ------- ORDER ----- EMPTY MUST ALWAYS BE FIRST, others in alphabetical order

//  List_Name, List_Tooltip,
//    kcal, fats, carb, prot, fibr
	["", "", 
		0], 
	["Cacao", "1 dose = 38g",
		3.75],
	["Gall. riso Coop", "3 gallette = 25g",
		377, 1.7, 81, 7.5, 3.9],
	["Latte", "",
		48],
	
];


const menu = {};
var i = 0;

var kCalDay = {
	breakfast: 0,
	snackM:    0,
	lunch:     0,
	snack2:    0,
	dinner:    0
}
	

function getValue(name) { return document.getElementById(name).textContent; }

function setValue(name, value) { return document.getElementById(name).innerHTML = value; }	
	



// reads ingredients list, appends all ingredients as options to dropdown menu
function buildList(source) {
	let select = document.createElement("select");
 
	for (let i=0; i<source.length; i++) {
		let option = document.createElement("option"); 
		option.innerHTML = source[i][0];
		option.setAttribute("value", i);
		select.appendChild(option);
	}

	return select
}

function addRow(meal) {

	let parent = document.getElementById(meal);
	
	let line = document.createElement("div");
		line.setAttribute("class", "ingredient");
	
	let select = buildList(ingredients);
		select.setAttribute("class", "vertCenter");
		select.setAttribute("onchange", "setIngredientProperties()");
	
	let iMass = document.createElement("input");
		iMass.setAttribute("class", "item_mass vertCenter unselectable");
		iMass.setAttribute("type", "tel");	
		iMass.setAttribute("onkeyup", "userInput()");		
		
	let times = document.createElement("span");
		times.setAttribute("class", "smallFont vertCenter unselectable");	
		times.textContent = "x";
	
	let uKcal = document.createElement("div");
		uKcal.setAttribute("class", "unit_kcal vertCenter unselectable smallfont");
		uKcal.textContent = 0;
		
	let equal = document.createElement("span");
		equal.setAttribute("class", "smallFont vertCenter unselectable");	
		equal.textContent = "=";
	
	let iKcal = document.createElement("div");
		iKcal.setAttribute("class", "item_kcal vertCenter unselectable");	
		iKcal.textContent = 0;	
		
	let enable = document.createElement("button");
		enable.setAttribute("class", "minus smallFont unselectable");
		enable.setAttribute("onclick", "enableDelete()");
		enable.textContent = "x";
	
	let remove = document.createElement("button");
		remove.setAttribute("class"  , "delete smallFont unselectable hidden");
		remove.setAttribute("onclick", "deleteRow()");
		remove.setAttribute("onblur" , "clearDelete()");		
		remove.textContent = "x";
	
	parent.appendChild(line);
		line.appendChild(select);
		line.appendChild(iMass);
		line.appendChild(times);
		line.appendChild(uKcal);
		line.appendChild(equal);
		line.appendChild(iKcal);
		line.appendChild(enable);		
		line.appendChild(remove);
		
}

function enableDelete(){

	let caller = event.currentTarget;             // .minus button
	let row    = caller.parentNode;               // .ingredient
	let depend = row.querySelector(".delete")     // .delete button
	
	
	caller.removeAttribute("onclick");
	
	setTimeout(function(){
		caller.classList.toggle("hidden");
		depend.classList.toggle("hidden");
		depend.focus();
	},100);
}

function clearDelete(){

	let caller = event.currentTarget;             // .delete button
	let row    = caller.parentNode;               // .ingredient
	let depend = row.querySelector(".minus")      // .minus button
	
	caller.classList.toggle("hidden");
	depend.classList.toggle("hidden");
	depend.setAttribute("onclick", "enableDelete()");
}

function deleteRow() {
	
	let caller = event.currentTarget;
	let meal   = caller.parentNode.parentNode.parentNode.parentNode;
	let riga   = caller.parentNode;
	riga.parentNode.removeChild(riga);
	
	calculateMeal(meal);
}

 


function toggleBlock() {

	let caller = event.currentTarget;
	//console.log(caller);
	
	let block  = caller.parentNode.querySelector(".meal_block");
	//console.log(block);
	
	block.classList.toggle("hidden") ;
	event.currentTarget.querySelector(".arrow").classList.toggle("up");

}

function setIngredientProperties() {

	let caller     = event.currentTarget;

	let chosenIngr = caller.value;
	let activeRow  = caller.parentNode;
	let baseKcal   = activeRow.querySelector(".unit_kcal");
	
	baseKcal.textContent = ingredients[chosenIngr][2];
	
	ingredients[chosenIngr][1] 
		? setValue("footer", "<b>" + ingredients[chosenIngr][0] + ":</b> " + ingredients[chosenIngr][1])
		: setValue("footer", "");
	
	calculateIngredient(caller);
}

function userInput() {

	let caller = event.currentTarget;
	caller.focus();
	
	let temp = parseInt(caller.value);
	
	caller.value = isNaN(temp) ? 0 : temp;
	
	calculateIngredient(caller);
	
	caller.addEventListener("keydown", function(event) {
		if (event.key === "Enter") {
			caller.blur();
		}
	});
}



function setMass() {
	
	let caller = event.currentTarget;
	let meal   = caller.parentNode.parentNode.parentNode.parentNode;
	
	let value;
	let userInput = parseInt(prompt("Quantita':", ""), 10);
	
	userInput 
		? value = userInput
		: value = 0;
	
	caller.textContent = value;
	
	
	calculateIngredient(caller);
	
}

function calculateIngredient(eventCaller) {
	
	let caller;
	let meal; 
	
	console.log(eventCaller);
	
	eventCaller 
		? caller = eventCaller
		: caller = event.currentTarget;

	console.log(caller);
	meal = caller.parentNode.parentNode.parentNode.parentNode;
		
	let itemMass_id = caller.parentNode.querySelector(".item_mass");
	let unitKcal_id = caller.parentNode.querySelector(".unit_kcal");
	let itemKcal_id = caller.parentNode.querySelector(".item_kcal");
	
	mass = itemMass_id.value;
	kcal = unitKcal_id.textContent;
	
	itemKcal_id.textContent = Math.round(mass * kcal / 100); 
	
	calculateMeal(meal);
}


function calculateMeal(meal){

	let mealId;
	let mealKcalList;
	let mealKcalTot = 0;
	
	meal 
		? mealId = meal
		: mealId = event.parentNode.parentNode.parentNode.parentNode;
		
	//console.log(mealId);
	
	mealKcalList = mealId.querySelectorAll(".item_kcal")
	//console.log(mealKcalList);
	
	mealKcalList.forEach(function(el){
		mealKcalTot += parseInt(el.textContent, 10);
	});
	
	mealId.querySelector(".meal_kcal").textContent = mealKcalTot;
	
	calculateDay();
}

function calculateDay() {
	let allMealsList  = document.querySelectorAll(".meal_kcal");
	
	let allMealsValue = 0;

	allMealsList.forEach(function(el){
		allMealsValue += parseInt(el.textContent, 10);
	});	
	
	setValue("day_kcal", allMealsValue);	
}


window.onload = function(){

	addRow("breakfast_list");
	addRow("snack1_list");
	addRow("lunch_list");
	addRow("snack2_list");
	addRow("dinner_list");
};

</script>

<style>
html {
	font-size: 16px;
}

.smallFont {
	font-size: 10px;
}

body {
	background-color: #666666;
	margin: 0px;
	padding: 0px;
	font-family: arial;
}

#container {
	box-sizing: border-box;
	width:100%;
	max-width:400px;
	/*margin: 5px;*/
	padding: 5px;
	border-bottom: 3px solid black;
	position: fixed;
	top: 0px;
	bottom: 3rem;
	overflow: overlay;
}

#footer {
	box-sizing: border-box;
	width:100%;
	max-width:400px;
	padding: 5px;
	/*border: 1px solid black;*/
	position: fixed;
	bottom: 0px;
	height: 3rem;
	overflow: hidden;
	background-color: #ccccff;
}

.meal_group {
}

.meal_header, #app_header {
	font-weight: bold;
	height: 2rem;
	display:flex;
	align-items: center;
	border: 2px solid black;
	border-radius: 2rem;
	margin-top: 0.5rem;
	margin-bottom: 0.5rem;
	background-color: #fffff0;
}

.meal_header {
	margin-right: 2rem;
}

#app_header {
	font-variant: small-caps;
}

.meal_name, #app_name {
	display: inline-block;
	margin-left: 1rem;
	margin-right: 1rem;
	width: 4rem;
	flex-grow: 1;
}

#app_name {
	color: blue;
	font-size: larger;
	font-style: italic;
}



.arrow {
	width:  1.2em;
	height: 0.7em;
}

.up {
    -ms-transform: rotate(180deg); /* IE 9 */
    -webkit-transform: rotate(180deg); /* Safari */
    transform: rotate(180deg);
}

.ingredient {
	margin-top: 0.5rem;
	margin-bottom: 0.5rem;
	margin-left: 0.5rem;
	height:2em;
	display:flex;
	align-items: center;
}

select {
	flex-grow: 1;
	box-sizing: border-box;
	display: inline-block;
	height: 2em;
	width: 4em;
	margin-left: 0.5em;
	margin-right: 0.5em;
	font-size: 10px;
}

.item_mass, .unit_kcal, .item_kcal, .meal_kcal, #day_kcal {
	box-sizing:border-box;
	display: flex;
	width: 3rem;
	height: 1.5rem;
	padding-left:  2px;
	padding-right: 2px;
	border-width: 1px;
	border-style: solid; 
	border-radius: 1rem;
	justify-content: flex-end;
	align-items: center;
	overflow: hidden;
}

.item_mass, .unit_kcal, .item_kcal, .meal_kcal {
	margin-left: 0.25rem;
	margin-right:0.25rem;
}

#day_kcal {
	margin-left: 0.25rem;
	margin-right:2.25rem;
}


.item_mass, select {
	background-color: #ffffaa;
}

.unit_kcal, .item_kcal, .meal_kcal, #day_kcal {
	background-color: #cccccc;
}

.item_mass, .unit_kcal, .item_kcal, .meal_kcal {
	border-color: black;
}

#day_kcal {
	border-color: blue;
}


button {
	box-sizing: border-box; 
	border-width:2px;
	border-style: solid;

	padding:0px;
	text-align:center;
	-webkit-appearance: none;
	-moz-appearance: none;
	appearance: none;
}
	
.plus {
	border-color: green;
	border-radius: 0.75em;
	height: 1.5em;
	width:  4rem;
	margin-left: 4rem;
	background-color: #aaffaa;
}

.minus, .delete {
	border-color: red;
	border-radius: 50%;
	color: red;
}

.minus {
	height: 1rem;
	width:  1rem;
	margin-right: 0.5rem;
	margin-left:  0.5rem;
	background-color: #ffaaaa;
	color: red;
}

.delete {
	height: 1.5rem;
	width:  1.5rem;
	margin-right: 0.25rem;
	margin-left:  0.25rem;
	background-color: #ff0000;
	color: white;
}

.hidden {
	display: none;
}

.vertCenter {
	margin-top: auto;
	margin-bottom:auto;
}

.deleteRowIcon {
	height: 1.5em;
	width: 1.5em;
}

.arrow {
	width:  1.2em;
	height: 0.7em;
}

.up {
    -ms-transform: rotate(180deg); /* IE 9 */
    -webkit-transform: rotate(180deg); /* Safari */
    transform: rotate(180deg);
}

.unselectable {
	user-select: none;
	-moz-user-select: none;
	-webkit-user-select: none;
	-ms-user-select: none;
}

</style>


</head>


<body>


<div id="container">

	<div id="app_header">
		<div class="unselectable" id="app_name">Diet Helper</div>
		<div class="unselectable" id="day_kcal"></div>
	</div>

<!-- BREAKFAST -->
	<div class="meal_group" id="breakfast_group">
		<div class="meal_header" onclick="toggleBlock()">
			<div class="meal_name unselectable">
				<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="arrow up" x="0px" y="0px" viewBox="0 0 960 560" enable-background="new 0 0 960 560" xml:space="preserve">
					<path d="M480,344.181L268.869,131.889c-15.756-15.859-41.3-15.859-57.054,0c-15.754,15.857-15.754,41.57,0,57.431l237.632,238.937   c8.395,8.451,19.562,12.254,30.553,11.698c10.993,0.556,22.159-3.247,30.555-11.698l237.631-238.937   c15.756-15.86,15.756-41.571,0-57.431s-41.299-15.859-57.051,0L480,344.181z"/>
				</svg>
				Colazione
			</div>
			<div class="meal_kcal unselectable">0</div>
		</div>

		<div class="meal_block" id="breakfast_block">
			<div id="breakfast_list"></div>
			<button class="plus unselectable" onclick="addRow('breakfast_list')">+</button>
		</div>
	</div>

	
<!-- SNACK (MORNING)-->
	<div class="meal_group" id="snack1_group">
		<div class="meal_header" onclick="toggleBlock()">
			<div class="meal_name unselectable">
				<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="arrow up" x="0px" y="0px" viewBox="0 0 960 560" enable-background="new 0 0 960 560" xml:space="preserve">
					<path d="M480,344.181L268.869,131.889c-15.756-15.859-41.3-15.859-57.054,0c-15.754,15.857-15.754,41.57,0,57.431l237.632,238.937   c8.395,8.451,19.562,12.254,30.553,11.698c10.993,0.556,22.159-3.247,30.555-11.698l237.631-238.937   c15.756-15.86,15.756-41.571,0-57.431s-41.299-15.859-57.051,0L480,344.181z"/>
				</svg>
				Spuntino 1
			</div>
			<div class="meal_kcal unselectable">0</div>
		</div>

		<div class="meal_block" id="snack1_block">
			<div id="snack1_list"></div>
			<button class="plus unselectable" onclick="addRow('snack1_list')">+</button>
		</div>
	</div>
	

<!-- LUNCH -->	
	<div class="meal_group" id="lunch_group">
		<div class="meal_header" onclick="toggleBlock()">
			<div class="meal_name unselectable">
				<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="arrow up" x="0px" y="0px" viewBox="0 0 960 560" enable-background="new 0 0 960 560" xml:space="preserve">
					<path d="M480,344.181L268.869,131.889c-15.756-15.859-41.3-15.859-57.054,0c-15.754,15.857-15.754,41.57,0,57.431l237.632,238.937   c8.395,8.451,19.562,12.254,30.553,11.698c10.993,0.556,22.159-3.247,30.555-11.698l237.631-238.937   c15.756-15.86,15.756-41.571,0-57.431s-41.299-15.859-57.051,0L480,344.181z"/>
				</svg>
				Pranzo
			</div>
			<div class="meal_kcal unselectable">0</div>
		</div>

		<div class="meal_block" id="lunch_block">
			<div id="lunch_list"></div>
			<button class="plus unselectable" onclick="addRow('lunch_list')">+</button>
		</div>
	</div>
	

<!-- SNACK (AFTERNOON)-->	
	<div class="meal_group" id="snack2_group">
		<div class="meal_header" onclick="toggleBlock()">
			<div class="meal_name unselectable">
				<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="arrow up" x="0px" y="0px" viewBox="0 0 960 560" enable-background="new 0 0 960 560" xml:space="preserve">
					<path d="M480,344.181L268.869,131.889c-15.756-15.859-41.3-15.859-57.054,0c-15.754,15.857-15.754,41.57,0,57.431l237.632,238.937   c8.395,8.451,19.562,12.254,30.553,11.698c10.993,0.556,22.159-3.247,30.555-11.698l237.631-238.937   c15.756-15.86,15.756-41.571,0-57.431s-41.299-15.859-57.051,0L480,344.181z"/>
				</svg>
				Spuntino 2
			</div>
			<div class="meal_kcal unselectable">0</div>
		</div>

		<div class="meal_block" id="snack2_block">
			<div id="snack2_list"></div>
			<button class="plus unselectable" onclick="addRow('snack2_list')">+</button>
		</div>
	</div>
	

<!-- DINNER-->	
	<div class="meal_group" id="dinner_group">
		<div class="meal_header" onclick="toggleBlock()">
			<div class="meal_name unselectable">
				<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="arrow up" x="0px" y="0px" viewBox="0 0 960 560" enable-background="new 0 0 960 560" xml:space="preserve">
					<path d="M480,344.181L268.869,131.889c-15.756-15.859-41.3-15.859-57.054,0c-15.754,15.857-15.754,41.57,0,57.431l237.632,238.937   c8.395,8.451,19.562,12.254,30.553,11.698c10.993,0.556,22.159-3.247,30.555-11.698l237.631-238.937   c15.756-15.86,15.756-41.571,0-57.431s-41.299-15.859-57.051,0L480,344.181z"/>
				</svg>
				Cena
			</div>
			<div class="meal_kcal unselectable">0</div>
		</div>

		<div class="meal_block" id="dinner_block">
			<div id="dinner_list"></div>
			<button class="plus unselectable" onclick="addRow('dinner_list')">+</button>
		</div>
	</div>
	


</div> <!-- container -->


<div class="unselectable" id="footer"></div>






</body>
</html>
